---
- name: Setup Tomcat Server for Arbeit Application
  hosts: tomcat_servers
  become: yes
  
  tasks:
    - name: Update apt cache
      apt:
        update_cache: yes
        cache_valid_time: 3600
      when: ansible_os_family == "Debian"
      
    - name: Install required packages
      apt:
        name:
          - openjdk-21-jdk
          - curl
          - wget
          - unzip
          - git
        state: present
      when: ansible_os_family == "Debian"
      
    - name: Check if Tomcat is already installed
      stat:
        path: "{{ tomcat_home }}"
      register: tomcat_installed
      
    - name: Display Tomcat installation status
      debug:
        msg: "Tomcat is {{ 'already installed' if tomcat_installed.stat.exists else 'not installed' }}"
        
    - name: Create Tomcat user
      user:
        name: tomcat
        system: yes
        shell: /bin/false
        home: "{{ tomcat_home }}"
        createhome: no
      when: not tomcat_installed.stat.exists
      
    - name: Install Tomcat (if not exists)
      block:
        - name: Download Tomcat
          get_url:
            url: "https://archive.apache.org/dist/tomcat/tomcat-10/v10.1.30/bin/apache-tomcat-10.1.30.tar.gz"
            dest: "/tmp/tomcat10.tar.gz"
            
        - name: Create Tomcat directory
          file:
            path: "{{ tomcat_home }}"
            state: directory
            owner: "{{ app_user }}"
            group: "{{ app_group }}"
            
        - name: Extract Tomcat
          unarchive:
            src: "/tmp/tomcat10.tar.gz"
            dest: "{{ tomcat_home }}"
            remote_src: yes
            extra_opts: [--strip-components=1]
            owner: "{{ app_user }}"
            group: "{{ app_group }}"
            
        - name: Make scripts executable
          file:
            path: "{{ tomcat_home }}/bin"
            mode: 'u+x'
            recurse: yes
            
      when: not tomcat_installed.stat.exists
      
    - name: Create uploads directory for resumes
      file:
        path: "{{ tomcat_home }}/uploads/resumes"
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_group }}"
        mode: '0755'
        
    - name: Configure Tomcat server.xml (set port if needed)
      lineinfile:
        path: "{{ tomcat_home }}/conf/server.xml"
        regexp: 'Connector port="8080"'
        line: '    <Connector port="{{ tomcat_port }}" protocol="HTTP/1.1"'
        backrefs: yes
        
    - name: Ensure Tomcat is stopped before configuration
      shell: "{{ tomcat_home }}/bin/shutdown.sh"
      ignore_errors: yes
      
    - name: Display setup completion
      debug:
        msg:
          - "========================================="
          - "Tomcat server setup completed"
          - "Tomcat Home: {{ tomcat_home }}"
          - "Port: {{ tomcat_port }}"
          - "Ready for deployment"
          - "========================================="
