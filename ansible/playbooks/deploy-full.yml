---
- name: Deploy Complete Arbeit Application
  hosts: tomcat_servers
  become: yes
  
  vars:
    backend_war_path: "{{ playbook_dir }}/../../backend/target/arbeits-backend.war"
    frontend_build_path: "{{ playbook_dir }}/../../frontend/out"
    
  tasks:
    - name: Verify backend WAR exists
      stat:
        path: "{{ backend_war_path }}"
      register: war_file
      delegate_to: localhost
      become: no
      
    - name: Verify frontend build exists
      stat:
        path: "{{ frontend_build_path }}"
      register: frontend_build
      delegate_to: localhost
      become: no
      
    - name: Fail if artifacts don't exist
      fail:
        msg: "Required artifacts not found. Please build the project first."
      when: not war_file.stat.exists or not frontend_build.stat.exists
      
    - name: Stop Tomcat server
      shell: "{{ tomcat_home }}/bin/shutdown.sh"
      ignore_errors: yes
      
    - name: Wait for Tomcat to stop
      wait_for:
        port: "{{ tomcat_port }}"
        state: stopped
        timeout: 30
      ignore_errors: yes
      
    - name: Clean old deployments
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - "{{ tomcat_webapps }}/{{ backend_war_name }}"
        - "{{ tomcat_webapps }}/api"
        - "{{ tomcat_webapps }}/{{ frontend_app_name }}"
        
    - name: Deploy backend WAR
      copy:
        src: "{{ backend_war_path }}"
        dest: "{{ tomcat_webapps }}/{{ backend_war_name }}"
        owner: "{{ app_user }}"
        group: "{{ app_group }}"
        mode: '0644'
        
    - name: Create frontend directory
      file:
        path: "{{ tomcat_webapps }}/{{ frontend_app_name }}"
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_group }}"
        mode: '0755'
        
    - name: Deploy frontend build
      synchronize:
        src: "{{ frontend_build_path }}/"
        dest: "{{ tomcat_webapps }}/{{ frontend_app_name }}/"
        delete: yes
        recursive: yes
      delegate_to: localhost
      
    - name: Set correct permissions
      file:
        path: "{{ tomcat_webapps }}/{{ frontend_app_name }}"
        owner: "{{ app_user }}"
        group: "{{ app_group }}"
        recurse: yes
        
    - name: Start Tomcat server
      shell: "{{ tomcat_home }}/bin/startup.sh"
      
    - name: Wait for Tomcat to start
      wait_for:
        port: "{{ tomcat_port }}"
        state: started
        timeout: 60
        
    - name: Wait for applications to deploy
      wait_for:
        timeout: 20
        
    - name: Check backend health
      uri:
        url: "http://localhost:{{ tomcat_port }}/api/health"
        status_code: 200
      register: backend_health
      retries: 5
      delay: 10
      until: backend_health.status == 200
      ignore_errors: yes
      
    - name: Check frontend accessibility
      uri:
        url: "http://localhost:{{ tomcat_port }}/{{ frontend_app_name }}"
        status_code: 200
      register: frontend_check
      retries: 5
      delay: 10
      until: frontend_check.status == 200
      ignore_errors: yes
      
    - name: Display deployment summary
      debug:
        msg:
          - "========================================="
          - "Deployment completed on {{ inventory_hostname }}"
          - "Backend: {{ 'SUCCESS' if backend_health.status == 200 else 'CHECK REQUIRED' }}"
          - "Frontend: {{ 'SUCCESS' if frontend_check.status == 200 else 'CHECK REQUIRED' }}"
          - "========================================="
